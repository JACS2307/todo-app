<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>TaskFlow</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Page Header -->
  <div class="page-header">
    <h1>Categorías</h1>
    <p>Organiza tus tareas por categorías</p>
  </div>

  @if (categoryService.categories().length > 0) {
  <ion-list class="categories-list">
    @for (category of categoryService.categories(); track category.id) {
    <ion-item-sliding>
      <ion-item>
        <div
          class="category-color-indicator"
          [style.background-color]="category.color"
          slot="start"
        ></div>

        <ion-label>
          <h2>{{ category.name }}</h2>
          <p>
            <ion-icon [name]="category.icon || 'folder-outline'"></ion-icon>
            {{ getTaskCount(category.id) }} tareas
          </p>
        </ion-label>

        <div class="category-end" slot="end">
          <ion-badge [style.--background]="category.color">
            {{ getTaskCount(category.id) }}
          </ion-badge>
        </div>
      </ion-item>
      <ion-item-options side="end" class="category-actions">
        <ion-item-option color="primary" (click)="editCategory(category)">
          <ion-icon name="create" slot="icon-only"></ion-icon>
        </ion-item-option>
        <ion-item-option color="danger" (click)="deleteCategory(category)">
          <ion-icon name="trash" slot="icon-only"></ion-icon>
        </ion-item-option>
      </ion-item-options>
    </ion-item-sliding>
    }
  </ion-list>
  } @else {
  <div class="empty-state">
    <ion-icon name="color-palette-outline" size="large"></ion-icon>
    <h2>No hay categorías</h2>
    <p>Pulsa el botón + para crear una categoría</p>
  </div>
  }

  <!-- FAB para agregar categoría -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="openCategoryModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Modal para crear/editar categoría -->
  <ion-modal [isOpen]="isModalOpen()" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="closeModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title
            >{{ isEditing() ? "Editar" : "Nueva" }} Categoría</ion-title
          >
          <ion-buttons slot="end">
            <ion-button
              (click)="saveCategory()"
              [disabled]="!categoryForm.valid"
              strong
            >
              <ion-icon name="checkmark"></ion-icon>
              Guardar
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <!-- Vista previa -->
        <div class="preview-section">
          <span class="preview-label">Vista previa</span>
          <div class="preview-chip-container">
            <ion-chip [style.--background]="categoryForm.get('color')?.value">
              <ion-icon [name]="categoryForm.get('icon')?.value || 'folder-outline'"></ion-icon>
              {{ categoryForm.get("name")?.value || "Categoría" }}
            </ion-chip>
          </div>
        </div>

        <form [formGroup]="categoryForm">
          <ion-list>
            <!-- Nombre -->
            <ion-item>
              <ion-input
                formControlName="name"
                label="Nombre"
                labelPlacement="floating"
                placeholder="Nombre de la categoría"
                [clearInput]="true"
                required
              ></ion-input>
            </ion-item>
            @if (categoryForm.get('name')?.touched &&
            categoryForm.get('name')?.errors?.['required']) {
            <ion-note color="danger" class="ion-padding-start">
              El nombre es requerido
            </ion-note>
            }

          </ion-list>

          <!-- Acordeones de Color e Icono -->
          <ion-accordion-group class="accordion-group">
            <!-- Color -->
            <ion-accordion value="color">
              <ion-item slot="header" lines="full">
                <ion-label>Color</ion-label>
                <span
                  class="color-dot selected-indicator"
                  [style.background-color]="categoryForm.get('color')?.value"
                  slot="end"
                ></span>
              </ion-item>
              <div slot="content" class="accordion-content">
                <div class="color-grid">
                  @for (color of availableColors; track color) {
                  <button
                    type="button"
                    class="color-button"
                    [class.selected]="isColorSelected(color)"
                    [style.--color]="color"
                    (click)="selectColor(color)"
                  >
                    <span class="color-dot" [style.background-color]="color"></span>
                  </button>
                  }
                </div>
              </div>
            </ion-accordion>

            <!-- Icono -->
            <ion-accordion value="icon">
              <ion-item slot="header" lines="full">
                <ion-label>Icono</ion-label>
                <ion-icon
                  [name]="categoryForm.get('icon')?.value || 'folder-outline'"
                  class="selected-indicator"
                  slot="end"
                ></ion-icon>
              </ion-item>
              <div slot="content" class="accordion-content">
                <div class="icon-grid">
                  @for (icon of availableIcons; track icon) {
                  <button
                    type="button"
                    class="icon-button"
                    [class.selected]="isIconSelected(icon)"
                    [style.--selected-color]="categoryForm.get('color')?.value"
                    (click)="selectIcon(icon)"
                  >
                    <ion-icon [name]="icon"></ion-icon>
                  </button>
                  }
                </div>
              </div>
            </ion-accordion>
          </ion-accordion-group>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
